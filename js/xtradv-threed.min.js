/*! xtrad-viewer 06-12-2019 */

function boolToNum(t){return t?1:0}function decimalToHex(t){var e=Number(t).toString(16);return(e="000000".substr(0,6-e.length)+e).toUpperCase()}Number.prototype.format=function(){return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")};var xtrad_pluginUrl=xtradDirData.pluginurl,xtrad_uploadUrl=xtradDirData.uploadurl,XTRADVIEWER=XTRADVIEWER||{};XTRADVIEWER.Text=function(){this.fontType="",this.fontName="",this.colourType="",this.animateObject="",this.animateRotations={x:0,y:0,z:0},this.text="hello World!",this.font=null,this.size=10,this.height=1,this.curveSegments=4,this.bevelThickness=1,this.bevelSize=.1,this.bevelOffset=0,this.bevelSegments=2,this.bevelEnabled=!0,this.material=0,this.extrudeMaterial=1,this.materials=null,this.textMesh1=null,this.options="",this.textGeo=null,this.uniformscript="",this.posx=0,this.posy=0,this.posz=0,this.rotx=0,this.roty=2*Math.PI,this.rotz=0,this.positionx="center",this.scalex=1,this.scaley=1,this.scalez=1,this.colorf="#ffffff",this.colors="#ffffff"},XTRADVIEWER.Text.prototype.loadFont=function(t,e,a){var i=new XDTHREE.FontLoader,r=this;i.load(xtrad_pluginUrl+"/js/fonts/"+t+"_"+e+".typeface.json",function(t){r.font=t,a(t)})},XTRADVIEWER.Text.prototype.createText=function(t){(this.options=t).fontType&&(this.fontType=t.fontType),t.fontName&&(this.fontName=t.fontName),t.colourType&&(this.colourType=t.colourType),t.animateObject&&(this.animateObject=t.animateObject),t.animateRotations&&(this.animateRotations=t.animateRotations),t.text&&(this.text=t.text),t.font&&(this.font=t.font),null!=t.size&&(this.size=t.size),null!=t.height&&(this.height=t.height),null!=t.curveSegments&&(this.curveSegments=t.curveSegments),null!=t.bevelThickness&&(this.bevelThickness=t.bevelThickness),null!=t.bevelSize&&(this.bevelSize=t.bevelSize),null!=t.bevelOffset&&(this.bevelOffset=t.bevelOffset),null!=t.bevelEnabled&&(this.bevelEnabled=t.bevelEnabled),null!=t.hover&&(this.hover=t.hover),null!=t.material&&(this.material=t.material),null!=t.extrudeMaterial&&(this.extrudeMaterial=t.extrudeMaterial),t.materials&&(this.materials=t.materials),null!=t.posx&&(this.posx=t.posx),null!=t.posy&&(this.posy=t.posy),null!=t.posz&&(this.posz=t.posz),null!=t.positionx&&(this.positionx=t.positionx),null!=t.rotx&&(this.rotx=t.rotx),null!=t.roty&&(this.roty=t.roty),null!=t.rotz&&(this.rotz=t.rotz),null!=t.scalex&&(this.scalex=t.scalex),null!=t.scaley&&(this.scaley=t.scaley),null!=t.scalez&&(this.scalez=t.scalez),null!=t.uniformscript&&(this.uniformscript=t.uniformscript),this.textGeo=new XDTHREE.TextGeometry(this.text,{fontType:this.fontType,fontName:this.fontName,font:this.font,size:this.size,height:this.height,curveSegments:this.curveSegments,bevelThickness:this.bevelThickness,bevelSize:this.bevelSize,bevelOffset:this.bevelOffset,bevelEnabled:this.bevelEnabled,material:this.material,extrudeMaterial:this.extrudeMaterial,colourType:this.colourType,animateObject:this.animateObject,animateRotations:this.animateRotations,uniformscript:this.uniformscript}),this.textGeo.computeBoundingBox();var e=this.textGeo.boundingBox.max,a=this.textGeo.boundingBox.min,i=new XDTHREE.Vector2(0-a.x,0-a.y),r=new XDTHREE.Vector2(e.x-a.x,e.y-a.y),n=this.textGeo.faces;this.textGeo.faceVertexUvs[0]=[];for(var s=0;s<n.length;s++){var o=this.textGeo.vertices[n[s].a],h=this.textGeo.vertices[n[s].b],c=this.textGeo.vertices[n[s].c];this.textGeo.faceVertexUvs[0].push([new XDTHREE.Vector2((o.x+i.x)/r.x,(o.y+i.y)/r.y),new XDTHREE.Vector2((h.x+i.x)/r.x,(h.y+i.y)/r.y),new XDTHREE.Vector2((c.x+i.x)/r.x,(c.y+i.y)/r.y)])}if(this.textGeo.uvsNeedUpdate=!0,this.textGeo.computeBoundingBox(),this.textGeo.computeVertexNormals(),!this.bevelEnabled){var l=this.height*this.size*.1;for(s=0;s<this.textGeo.faces.length;s++){var u=this.textGeo.faces[s];if(1===u.materialIndex){for(var d=0;d<u.vertexNormals.length;d++)u.vertexNormals[d].z=0,u.vertexNormals[d].normalize();var p=this.textGeo.vertices[u.a],g=this.textGeo.vertices[u.b],b=this.textGeo.vertices[u.c];if(l<XDTHREE.GeometryUtils.triangleArea(p,g,b))for(d=0;d<u.vertexNormals.length;d++)u.vertexNormals[d].copy(u.normal)}}}var m=-.5*(this.textGeo.boundingBox.max.x-this.textGeo.boundingBox.min.x);switch(this.textMesh1=new XDTHREE.Mesh(this.textGeo,this.materials),-1!==this.text.indexOf("\n")?this.textMesh1.name="Text":this.textMesh1.name=this.text.replace(" ",""),this.textMesh1.castShadow=!0,this.textMesh1.receiveShadow=!0,this.positionx){case"center":this.textMesh1.position.x=m;break;case"left":this.textMesh1.position.x=0;break;case"right":this.textMesh1.position.x=this.textGeo.boundingBox.max.x}return this.pivot=new XDTHREE.Object3D,this.pivot.add(this.textMesh1),this.pivot},XTRADVIEWER.Text2D=function(){},XTRADVIEWER.Text2D.prototype.createText=function(t,e){this.text=t,this.parameters={},this.parameters.d2Type=e.d2Type||"3D",this.parameters.fontStyle=e.fontStyle||"normal",this.parameters.fontVariant=e.fontVariant||"normal",this.parameters.fontWeight=e.fontWeight||"normal",this.parameters.fontSize=e.fontSize||30,this.parameters.fontFamily=e.fontFamily||"Arial",this.parameters.font=this.parameters.fontStyle+" "+this.parameters.fontVariant+" "+this.parameters.fontWeight+" "+this.parameters.fontSize+"px "+this.parameters.fontFamily,this.parameters.align=e.align||"center",this.parameters.verticalAlign=e.verticalAlign||"middle",this.parameters.colorType=e.colorType||"color",this.parameters.color=e.color||"#FFFFFF",this.parameters.gradientColor1=e.gradientColor1||"#FFFFFF",this.parameters.gradientColor2=e.gradientColor2||"#000000",this.parameters.gradientAngle=null!=e.gradientAngle?e.gradientAngle:90,this.parameters.backgroundColorType=e.backgroundColorType||"none",this.parameters.backgroundColor=e.backgroundColor||"#000000",this.parameters.backgroundGradientColor1=e.backgroundGradientColor1||"#FFFFFF",this.parameters.backgroundGradientColor2=e.backgroundGradientColor2||"#000000",this.parameters.backgroundGradientAngle=null!=e.backgroundGradientAngle?e.backgroundGradientAngle:90,this.parameters.strokeStyle=e.strokeStyle||"normal",this.parameters.shadowColor=e.shadowColor||"rgba(0, 0, 0, 0)",this.parameters.shadowBlur=null!=e.shadowBlur?e.shadowBlur:0,this.parameters.shadowOffsetX=null!=e.shadowOffsetX?e.shadowOffsetX:0,this.parameters.shadowOffsetY=null!=e.shadowOffsetY?e.shadowOffsetY:0,this.parameters.widthSegments=e.widthSegments||1,this.parameters.heightSegments=e.heightSegments||1,this.parameters.side=null!=e.side?e.side:"Both",this.parameters.antiAlias=null==e.antiAlias||e.antiAlias,this.parameters.canvasPowerOf2=null==e.canvasPowerOf2||e.canvasPowerOf2,this.parameters.leftPadding=null!=e.leftPadding?e.leftPadding:10,this.parameters.rightPadding=null!=e.rightPadding?e.rightPadding:10,this.parameters.topPadding=null!=e.topPadding?e.topPadding:10,this.parameters.bottomPadding=null!=e.bottomPadding?e.bottomPadding:10,this.parameters.lineSpacing=null!=e.lineSpacing?e.lineSpacing:4,this.text2d=new XDTHREE.Text2DBufferGeometry(this.text,this.parameters);var a,i=new XDTHREE.Texture(this.text2d.canvas);(!1===this.antialias&&(i.magFilter=XDTHREE.NearestFilter,i.texture.minFilter=XDTHREE.LinearMipMapLinearFilter),i.needsUpdate=!0,"3D"===this.parameters.d2Type)?((a=new XDTHREE.MeshBasicMaterial({map:i,depthTest:!1,depthWrite:!1,fog:!1,side:"Front"===this.parameters.side?XDTHREE.FrontSide:XDTHREE.DoubleSide})).transparent="none"===this.parameters.backgroundColorType,this.textMesh1=new XDTHREE.Mesh(this.text2d,a),-1!==this.text.indexOf("\n")?this.textMesh1.name="Text":this.textMesh1.name=this.text.replace(" ","")):((a=new XDTHREE.SpriteMaterial({map:i,useScreenCoordinates:!1})).transparent="none"===this.parameters.backgroundColorType,this.textMesh1=new XDTHREE.Sprite(a),this.textMesh1.geometry=this.text2d,-1!==this.text.indexOf("\n")?this.textMesh1.name="Text":this.textMesh1.name=this.text.replace(" ",""));return this.textMesh1.castShadow=!0,this.textMesh1.receiveShadow=!0,this.textMesh1},XTRADVIEWER.VideoTexture=function(t){var e=document.createElement("video");return e.src=t,e.autoPlay=!0,e.loop=!0,e.controls=!0,e.load(),e.play(),this.videoTexture=new XDTHREE.VideoTexture(e,t),this.videoTexture.minFilter=XDTHREE.NearestFilter,this.dom=e,this.src=t,this},XTRADVIEWER.Gradient=function(t,e,a,i,r,n,s){this.type=t,this.colour1=e,this.colour2=a,this.angle=i,this.innerRadius=r,this.varyColour=n,this.varyColourRate=s,XTRADVIEWER.Gradient.prototype.toJSON=function(t){var e={metadata:{version:1,type:"Gradient",generator:"Gradient.toJSON"}};return e.type=this.type,e.colour1=this.colour1,e.colour2=this.colour2,e.angle=this.angle,e.innerRadius=this.innerRadius,e.varyColour=this.varyColour,e.varyColourRate=this.varyColourRate,e},XTRADVIEWER.Gradient.prototype.copy=function(t){return new XTRADVIEWER.Gradient(t.type,t.colour1,t.colour2,t.angle,t.innerRadius,t.varyColour,t.varyColourRate)}},XTRADVIEWER.Checkered=function(t,e,a,i,r,n,s,o,h,c,l,u,d,p,g,b){this.type=t,this.solidColour1=e,this.solidColour2=a,this.gradient1=new XTRADVIEWER.Gradient(i,r,n,s,o),this.gradient2=new XTRADVIEWER.Gradient(h,c,l,u,d),this.noInX=p,this.varyColour=g,this.varyColourRate=b,XTRADVIEWER.Checkered.prototype.toJSON=function(t){var e={metadata:{version:1,type:"Checkered",generator:"Checkered.toJSON"}};return e.type=this.type,e.solidColour1=this.solidColour1,e.solidColour2=this.solidColour2,e.gradient1=this.gradient1.toJSON(),e.gradient2=this.gradient2.toJSON(),e.noInX=this.noInX,e.varyColour=this.varyColour,e.varyColourRate=this.varyColourRate,e},XTRADVIEWER.Checkered.prototype.copy=function(t){return new XTRADVIEWER.Checkered(t.type,t.solidColour1,t.solidColour2,t.gradient1.type,t.gradient1.colour1,t.gradient1.colour2,t.gradient1.angle,t.gradient1.innerRadius,t.gradient2.type,t.gradient2.colour1,t.gradient2.colour2,t.gradient2.angle,t.gradient2.innerRadius,t.noInX,t.varyColour,t.varyColourRate)}},XTRADVIEWER.Background=function(t){this.backgroundObject=null,this.backgroundType="",this.update=!1,this.aspectRatio="16:9",this.imageRatio=1,this.shadeSize=100,this.shadeZPos=-50,this.planeCamera=null,this.planeMesh=null,this.boxMesh=null,this.scene_name=t,XTRADVIEWER.Background.prototype.createColorBackground=function(t){this.backgroundType="color",this.backgroundObject=new XDTHREE.Color(t),"undefined"!=typeof editor&&editor&&this.removeBackgroundScripts(editor)},XTRADVIEWER.Background.prototype.createImageBackground=function(t,e){this.backgroundType="image",this.mapping=e,this.update=!0,t.anisotropy=16,t.wrapS=parseInt(e.wrapS),t.wrapT=parseInt(e.wrapT),t.offset=new XDTHREE.Vector2(e.offsetU,e.offsetV),t.repeat=new XDTHREE.Vector2(e.repeatU,e.repeatV),t.rotation=e.rotation*(Math.PI/180),t.center=new XDTHREE.Vector2(e.centreU,e.centreV),this.backgroundObject=t,void 0!==editor&&null!=editor&&this.removeBackgroundScripts(editor)},XTRADVIEWER.Background.prototype.createVideoBackground=function(t,e){this.backgroundType="video";var a=null;if(this.aspectRatio=e,null!=t&&0<t.length){var i=xtrad_uploadUrl+"/xtrad-library/videos/"+t;(a=new XTRADVIEWER.VideoTexture(i)).videoTexture.anisotropy=16,this.backgroundObject=a.videoTexture}void 0!==editor&&null!=editor&&this.removeBackgroundScripts(editor)},XTRADVIEWER.Background.prototype.createCubeTextureBackground=function(t){this.backgroundType="cube",this.backgroundObject=t,void 0!==editor&&null!==editor&&this.removeBackgroundScripts(editor)},XTRADVIEWER.Background.prototype.createShaderBackground=function(n,t,e,a){this.backgroundType="shader",this.shadeSize=e,this.shadeZPos=a,this.backgroundObject=null;var s=this;!function(t,a){function e(t,e){shaderText=t.responseText,a(shaderText)}i=t,r=xtrad_uploadUrl+"/xtrad-library/shaders/"+i,jQuery.ajax({url:r,dataType:"text",complete:e});var i,r}(t,function(t){var e={},a="";try{json=JSON.parse(t),e=JSON.parse(json.uniforms),a=json.uniformScriptBackground}catch(t){alert(t)}material=new XDTHREE.ShaderMaterial({uniforms:e,vertexShader:json.vertex,fragmentShader:json.fragment}),s.backgroundObject=material,void 0!==n&&null!=n&&s.removeBackgroundScripts(n);var i="function update( event ) {\nvar time = event.time * 0.001;\nvar delta = event.delta * 0.001;\nvar timer = 0.001 * Date.now();\n";i+=a;var r={name:"background",source:i+="}"};n.execute(new AddScriptCommand(n.scene,r))})},XTRADVIEWER.Background.prototype.createGradientBackground=function(t,e,a,i,r,n,s){this.backgroundType="gradient",this.backgroundObject=new XTRADVIEWER.Gradient(t,e,a,i,r,n,s)},XTRADVIEWER.Background.prototype.createCheckeredBackground=function(t,e,a,i,r,n,s,o,h,c,l,u,d,p,g,b){this.backgroundType="checkered",this.backgroundObject=new XTRADVIEWER.Checkered(t,e,a,i,r,n,s,o,h,c,l,u,d,p,g,b)},XTRADVIEWER.Background.prototype.clone=function(){var t=new XTRADVIEWER.Background(this.scene_name);switch(t.backgroundType=this.backgroundType,t.backgroundObject=this.backgroundObject.copy(this.backgroundObject),t.backgroundType){case"image":t.imageRatio=this.imageRatio;break;case"video":t.aspectRatio=this.aspectRatio;break;case"shader":t.shadeSize=this.shadeSize,t.shadeZPos=this.shadeZPos}return t},XTRADVIEWER.Background.prototype.copy=function(t,e){var a=new XTRADVIEWER.Background(this.scene_name);switch(a.backgroundType=e.backgroundType,a.backgroundObject=e.backgroundObject.copy(e.backgroundObject),a.backgroundType){case"image":a.imageRatio=e.imageRatio;break;case"video":a.aspectRatio=e.aspectRatio;break;case"shader":a.shadeSize=e.shadeSize,a.shadeZPos=e.shadeZPos}return a},XTRADVIEWER.Background.prototype.toJSON=function(){var t={metadata:{version:1,type:"Background",generator:"Background.toJSON"}};t.backgroundType=this.backgroundType,t.imageRatio=this.imageRatio,t.aspectRatio=this.aspectRatio,t.width=this.width,t.height=this.height,t.shadeSize=this.shadeSize,t.shadeZPos=this.shadeZPos;var e={images:[],textures:[]};return"cube"===this.backgroundType?(t.backgroundObject=this.backgroundObject.toJSON(),t.backgroundObject.image):(t.backgroundObject=this.backgroundObject.toJSON(e),"image"!==this.backgroundType&&"video"!==this.backgroundType||(t.backgroundObject.image=e.images[this.backgroundObject.image.uuid])),t},XTRADVIEWER.Background.prototype.parse=function(a){function t(t,e){return"number"==typeof t?t:(console.warn("XDTHREE.ObjectLoader.parseTexture: Constant should be in numeric form.",t),e[t])}var e,i,r=null;if(Number.isInteger(a.background))(r=new XTRADVIEWER.Background(this.scene_name)).createColorBackground(a.background);else{var n=a.background.backgroundType;if(null!=n)switch(r=new XTRADVIEWER.Background(this.scene_name),n){case"color":r.createColorBackground(a.background.backgroundObject);break;case"image":r.backgroundType="image",r.imageRatio=a.background.imageRatio;var s=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(a.background.backgroundObject.image.url)?a.background.backgroundObject.image.url:scope.texturePath+a.background.backgroundObject.image.url,o=new XDTHREE.LoadingManager,h=new XDTHREE.ImageLoader(o),c=new XDTHREE.Texture((i=s,(e=o).itemStart(i),h.load(i,function(){e.itemEnd(i)},void 0,function(){e.itemEnd(i),e.itemError(i)})));c.needsUpdate=!0,c.uuid=a.background.uuid,void 0!==a.background.backgroundObject.mapping&&(c.mapping=t(a.background.backgroundObject.mapping,XDTHREE.TEXTURE_MAPPING)),void 0!==a.background.backgroundObject.offset&&c.offset.fromArray(a.background.backgroundObject.offset),void 0!==a.background.backgroundObject.repeat&&c.repeat.fromArray(a.background.backgroundObject.repeat),void 0!==a.background.backgroundObject.center&&c.center.fromArray(a.background.backgroundObject.center),void 0!==a.background.backgroundObject.rotation&&(c.rotation=a.background.backgroundObject.rotation),void 0!==a.background.backgroundObject.wrap&&(c.wrapS=t(a.background.backgroundObject.wrap[0],XDTHREE.TEXTURE_WRAPPING),c.wrapT=t(a.background.backgroundObject.wrap[1],XDTHREE.TEXTURE_WRAPPING)),void 0!==a.background.backgroundObject.minFilter&&(c.minFilter=t(a.background.backgroundObject.minFilter,XDTHREE.TEXTURE_FILTER)),void 0!==a.background.backgroundObject.magFilter&&(c.magFilter=t(a.background.backgroundObject.magFilter,XDTHREE.TEXTURE_FILTER)),void 0!==a.background.backgroundObject.anisotropy&&(c.anisotropy=a.background.backgroundObject.anisotropy),void 0!==a.background.backgroundObject.flipY&&(c.flipY=a.background.backgroundObject.flipY),r.backgroundObject=c;break;case"video":r.backgroundType="video",r.aspectRatio=a.background.aspectRatio;var l=new XTRADVIEWER.VideoTexture(a.background.backgroundObject.image.url).videoTexture;l.needsUpdate=!0,l.uuid=a.background.backgroundObject.uuid,void 0!==a.background.backgroundObject.mapping&&(l.mapping=t(a.background.backgroundObject.mapping,XDTHREE.TEXTURE_MAPPING)),void 0!==a.background.backgroundObject.offset&&l.offset.fromArray(a.background.backgroundObject.offset),void 0!==a.background.backgroundObject.repeat&&l.repeat.fromArray(a.background.backgroundObject.repeat),void 0!==a.background.backgroundObject.center&&l.center.fromArray(a.background.backgroundObject.center),void 0!==a.background.backgroundObject.rotation&&(l.rotation=a.background.backgroundObject.rotation),void 0!==a.background.backgroundObject.wrap&&(l.wrapS=t(a.background.backgroundObject.wrap[0],XDTHREE.TEXTURE_WRAPPING),l.wrapT=t(a.background.backgroundObject.wrap[1],XDTHREE.TEXTURE_WRAPPING)),void 0!==a.background.backgroundObject.minFilter&&(l.minFilter=t(a.background.backgroundObject.minFilter,XDTHREE.TEXTURE_FILTER)),void 0!==a.background.backgroundObject.magFilter&&(l.magFilter=t(a.background.backgroundObject.magFilter,XDTHREE.TEXTURE_FILTER)),void 0!==a.background.backgroundObject.anisotropy&&(l.anisotropy=a.background.backgroundObject.anisotropy),void 0!==a.background.backgroundObject.flipY&&(l.flipY=a.background.backgroundObject.flipY),r.backgroundObject=l;break;case"shader":r.backgroundType="shader",r.shadeSize=a.background.shadeSize,r.shadeZPos=a.background.shadeZPos;var u=new XDTHREE.ShaderMaterial({uniforms:a.background.backgroundObject.uniforms,vertexShader:a.background.backgroundObject.vertexShader,fragmentShader:a.background.backgroundObject.fragmentShader});r.backgroundObject=u;break;case"cube":r.backgroundType="cube",r.backgroundObject=(new XDTHREE.CubeTextureLoader).load(a.background.backgroundObject.image,!0,function(t){if(r.backgroundObject=t,r.backgroundObject.format=XDTHREE.RGBFormat,null!=r.backgroundObject.image)for(var e=0;e<r.backgroundObject.image.length;e++)r.backgroundObject.image[e].width=null!=a.background.backgroundObject.cubeWidth?a.background.backgroundObject.cubeWidth:0,r.backgroundObject.image[e].height=null!=a.background.backgroundObject.cubeHeight?a.background.backgroundObject.cubeHeight:0;void 0!==xtrad_CubeTexture[a.name]&&null!=xtrad_CubeTexture[a.name]&&--xtrad_CubeTexture[a.name]}),r.backgroundObject.format=XDTHREE.RGBFormat;break;case"gradient":r.createGradientBackground(a.background.backgroundObject.type,a.background.backgroundObject.colour1,a.background.backgroundObject.colour2,a.background.backgroundObject.angle,a.background.backgroundObject.innerRadius,a.background.backgroundObject.varyColour,a.background.backgroundObject.varyColourRate);break;case"checkered":r.createCheckeredBackground(a.background.backgroundObject.type,a.background.backgroundObject.solidColour1,a.background.backgroundObject.solidColour2,a.background.backgroundObject.gradient1.type,a.background.backgroundObject.gradient1.colour1,a.background.backgroundObject.gradient1.colour2,a.background.backgroundObject.gradient1.angle,a.background.backgroundObject.gradient1.innerRadius,a.background.backgroundObject.gradient2.type,a.background.backgroundObject.gradient2.colour1,a.background.backgroundObject.gradient2.colour2,a.background.backgroundObject.gradient2.angle,a.background.backgroundObject.gradient2.innerRadius,a.background.backgroundObject.noInX,a.background.backgroundObject.varyColour,a.background.backgroundObject.varyColourRate)}else null!=a.background.metadata&&"CubeTexture"===a.background.metadata.type?((r=(new XDTHREE.CubeTextureLoader).load(a.background.image,!0)).format=XDTHREE.RGBFormat,r.uuid=a.background.uuid):r=a.background}return r},XTRADVIEWER.Background.prototype.render=function(t,e,a,i,r){if(null!=this.backgroundObject)switch(this.backgroundType){case"cube":if(null==this.boxMesh){var n=XDTHREE.ShaderLib.cube;n.uniforms.tCube.value=this.backgroundObject;var s=new XDTHREE.ShaderMaterial({fragmentShader:n.fragmentShader,vertexShader:n.vertexShader,uniforms:n.uniforms,side:XDTHREE.BackSide}),o=new XDTHREE.BoxBufferGeometry(10100,10100,10100),h=new XDTHREE.Mesh(o,s);h.name="XtradSky",h.rotation.y=Math.PI/180*180,this.boxMesh=new XDTHREE.Mesh(o,s),this.boxMesh.geometry.removeAttribute("normal"),this.boxMesh.geometry.removeAttribute("uv"),t.update(this.boxMesh)}e.renderBufferDirect(r,null,this.boxMesh.geometry,this.boxMesh.material,this.boxMesh,null);break;case"image":(null==this.planeCamera||this.update)&&(this.planeCamera=new XDTHREE.OrthographicCamera(-1,1,1,-1,0,1),this.planeMesh=new XDTHREE.Mesh(new XDTHREE.PlaneBufferGeometry(2,2),new XDTHREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1})),this.backgroundObject.flipY=!0,this.backgroundObject.needsUpdate=!0,this.planeMesh.material.map=this.backgroundObject,t.update(this.planeMesh),this.update=!1),e.renderBufferDirect(this.planeCamera,null,this.planeMesh.geometry,this.planeMesh.material,this.planeMesh,null);break;case"video":if((null==this.planeCamera||null==this.planeMesh)&&null==this.planeCamera){this.planeCamera=new XDTHREE.OrthographicCamera(-1,1,1,-1,0,1);var c=1;switch(this.aspectRatio){case"Square":break;case"4:3":c=.75;break;case"16:9":c=9/16;break;case"16:10":c=.625}null==this.planeMesh&&(this.planeMesh=new XDTHREE.Mesh(new XDTHREE.PlaneBufferGeometry(2,2*c),new XDTHREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1})),t.update(this.planeMesh),this.planeMesh.material.map=this.backgroundObject)}e.renderBufferDirect(this.planeCamera,null,this.planeMesh.geometry,this.planeMesh.material,this.planeMesh,null);break;case"shader":null==this.planeMesh&&(this.planeMesh=new XDTHREE.Mesh(new XDTHREE.PlaneBufferGeometry(this.shadeSize,this.shadeSize),this.backgroundObject),t.update(this.planeMesh),this.planeMesh.position.z=this.shadeZPos),a.unshift(this.planeMesh,this.planeMesh.geometry,this.planeMesh.material,0,0,null);break;case"gradient":if(null==this.planeCamera){this.planeCamera=new XDTHREE.OrthographicCamera(-1,1,1,-1,0,1);var l=1024,u=1024;switch(null!=(y=document.getElementById("xtrad-viewer"))?(0<y.clientWidth&&(l=y.clientWidth),0<y.clientHeight&&(u=y.clientHeight)):null!=(y=document.getElementById("playercanvasid"))?(0<y.clientWidth&&(l=y.clientWidth),0<y.clientHeight&&(u=y.clientHeight)):"undefined"!=typeof xtrad_Viewer&&null!==xtrad_Viewer&&(l=xtrad_Viewer.container.clientWidth-300,u=xtrad_Viewer.container.clientHeight),(k=document.createElement("canvas")).width=l,k.height=u,(x=k.getContext("2d")).rect(0,0,l,u),this.backgroundObject.type){case"Linear":var d=this.generateLinearGradient(x,0,0,l,u,this.backgroundObject.colour1,this.backgroundObject.colour2,this.backgroundObject.angle);break;case"Radial":d=this.generateRadialGradient(x,0,0,l,u,this.backgroundObject.colour1,this.backgroundObject.colour2,this.backgroundObject.innerRadius)}x.fillStyle=d,x.fill(),(T=new XDTHREE.Texture(k)).needsUpdate=!0;var p=new XDTHREE.MeshBasicMaterial({map:T,depthTest:!1,depthWrite:!1,fog:!1}),g=new XDTHREE.PlaneBufferGeometry(2,2);if(this.planeMesh=new XDTHREE.Mesh(g,p),this.planeMesh.renderOrder=-9999,t.update(this.planeMesh),"undefined"!=typeof editor&&null!==editor){var b={},m="";if(this.backgroundObject.varyColour){b.h=0,b.varyColourSpeed=this.backgroundObject.varyColourRate;m="function update( event ) {\nvar time = event.time * 0.001;\nvar delta = event.delta * 0.001;\nvar timer = 0.001 * Date.now();\n";m+="if(this.background.planeMesh != null){\n",m+="var material = this.background.planeMesh.material;\n",m+="this.userData.h = ( 360 * ( 1.0 + ( timer * this.userData.varyColourSpeed / 10.0 ) ) % 360 ) / 360;\n",m+="material.color.setHSL( this.userData.h, 0.5, 0.5 );\n",m+="}\n",m+="}\n",this.removeBackgroundScripts(editor),editor.scene.userData=b;var f={name:"background"+type,source:m};editor.execute(new AddScriptCommand(editor.scene,f))}}}e.renderBufferDirect(this.planeCamera,null,this.planeMesh.geometry,this.planeMesh.material,this.planeMesh,null);break;case"checkered":if(null==this.planeCamera){this.planeCamera=new XDTHREE.OrthographicCamera(-1,1,1,-1,0,1);var y,k;l=1024,u=1024;null!=(y=document.getElementById("xtrad-viewer"))?(0<y.clientWidth&&(l=y.clientWidth),0<y.clientHeight&&(u=y.clientHeight)):null!=(y=document.getElementById("playercanvasid"))?(0<y.clientWidth&&(l=y.clientWidth),0<y.clientHeight&&(u=y.clientHeight)):"undefined"!=typeof xtrad_Viewer&&null!==xtrad_Viewer&&(l=xtrad_Viewer.container.clientWidth-300,u=xtrad_Viewer.container.clientHeight),(k=document.createElement("canvas")).width=l,k.height=u;var T,E=l/this.backgroundObject.noInX,R=Math.ceil(l/E),v=Math.ceil(u/E),x=k.getContext("2d");switch(this.backgroundObject.type){case"Solid":for(var D=0;D<v;D++)for(var O=0;O<R;O++)x.fillStyle=(D+O)%2?this.backgroundObject.solidColour1:this.backgroundObject.solidColour2,x.fillRect(O*E,D*E,E,E);break;case"Gradient":for(D=0;D<v;D++)for(O=0;O<R;O++)x.fillStyle=(D+O)%2?"Linear"===this.backgroundObject.gradient1.type?this.generateLinearGradient(x,O*E,D*E,E,E,this.backgroundObject.gradient1.colour1,this.backgroundObject.gradient1.colour2,this.backgroundObject.gradient1.angle):this.generateRadialGradient(x,O*E,D*E,E,E,this.backgroundObject.gradient1.colour1,this.backgroundObject.gradient1.colour2,this.backgroundObject.gradient1.innerRadius):"Linear"===this.backgroundObject.gradient2.type?this.generateLinearGradient(x,O*E,D*E,E,E,this.backgroundObject.gradient2.colour1,this.backgroundObject.gradient2.colour2,this.backgroundObject.gradient2.angle):this.generateRadialGradient(x,O*E,D*E,E,E,this.backgroundObject.gradient2.colour1,this.backgroundObject.gradient2.colour2,this.backgroundObject.gradient2.innerRadius),x.fillRect(O*E,D*E,E,E)}(T=new XDTHREE.Texture(k)).needsUpdate=!0;p=new XDTHREE.MeshBasicMaterial({map:T,depthTest:!1,depthWrite:!1,fog:!1}),g=new XDTHREE.PlaneBufferGeometry(2,2);if(this.planeMesh=new XDTHREE.Mesh(g,p),this.planeMesh.renderOrder=-9999,t.update(this.planeMesh),"undefined"!=typeof editor&&null!==editor){b={},m="";if(this.backgroundObject.varyColour){b.h=0,b.varyColourSpeed=this.backgroundObject.varyColourRate;m="function update( event ) {\nvar time = event.time * 0.001;\nvar delta = event.delta * 0.001;\nvar timer = 0.001 * Date.now();\n";m+="if(this.background.planeMesh != null){\n",m+="var material = this.background.planeMesh.material;\n",m+="this.userData.h = ( 360 * ( 1.0 + ( timer * this.userData.varyColourSpeed / 10.0 ) ) % 360 ) / 360;\n",m+="material.color.setHSL( this.userData.h, 0.5, 0.5 );\n",m+="}\n",m+="}\n",this.removeBackgroundScripts(editor),editor.scene.userData=b;f={name:"background"+type,source:m};editor.execute(new AddScriptCommand(editor.scene,f))}}}e.renderBufferDirect(this.planeCamera,null,this.planeMesh.geometry,this.planeMesh.material,this.planeMesh,null)}},XTRADVIEWER.Background.prototype.generateLinearGradient=function(t,e,a,i,r,n,s,o){var h=o*Math.PI/180,c=i*Math.cos(h),l=r*Math.sin(h);if(0<=c&&0<=l)(u=t.createLinearGradient(e,a,c+e,l+a)).addColorStop(0,n),u.addColorStop(1,s);else if(0<=c&&l<0){(u=t.createLinearGradient(e,a,Math.abs(c)+e,Math.abs(l)+a)).addColorStop(1,n),u.addColorStop(0,s)}else if(c<0&&0<=l){(u=t.createLinearGradient(e,a,Math.abs(c)+e,l+a)).addColorStop(1,n),u.addColorStop(0,s)}else if(c<0&&l<0){var u;(u=t.createLinearGradient(e,a,Math.abs(c)+e,Math.abs(l)+a)).addColorStop(1,n),u.addColorStop(0,s)}return u},XTRADVIEWER.Background.prototype.generateRadialGradient=function(t,e,a,i,r,n,s,o){var h=t.createRadialGradient(e+i/2,a+r/2,o,e+i/2,a+r/2,i/2);return h.addColorStop(0,n),h.addColorStop(1,s),h},XTRADVIEWER.Background.prototype.removeBackgroundScripts=function(t){if(null!=t.scripts){var e=t.scripts[t.scene.uuid];if(null!=e){for(var a=e.length-1;0<=a;--a){"background"===e[a].name&&e.splice(a,1)}0===e.length&&delete t.scripts[t.scene.uuid]}}},XTRADVIEWER.Background.prototype.resize=function(t,e,a){}};var XTRADPLAYER=XTRADPLAYER||{},XTRADANIMATION=(XTRADPLAYER={Player:function(){this.container=null,this.homeUrl="",this.scene_name="",this.jsonstr="",this.json="",this.orbit=!1,this.appPlayer=null,this.width=0,this.height=0,this.heightRatio=0,this.load=function(t,e,a,i,o,r,n,s,h){this.container=t,this.containerimage=e,this.homeUrl=i,this.scene_name=o,this.jsonstr=r,this.orbit=s;try{if("compressed"===n)r=(new Huffman).decompress(r);JSON.parse(r);if(this.json=JSON.parse(this.jsonstr),xtrad_fontCount[o]=0,xtrad_CubeTexture[o]=0,xtrad_texg[o]={},xtrad_fonts[o]={},this.heightRatio=50,null!=this.json.project&&null!=this.json.project.heightRatio&&(this.heightRatio=this.json.project.heightRatio),this.width=a,this.height=a*(this.heightRatio/100),!h){var c=this.json.project.image;c=atob(c);var l=document.createElement("img");for(l.src=c,l.height=this.height,l.width=this.width;this.containerimage.hasChildNodes();)this.containerimage.removeChild(this.containerimage.lastChild);!!document.documentMode?this.containerimage.appendChild(l):this.containerimage.append(l)}this.container.style.display="none",this.containerimage.style.display="block",xtrad_o_traverse_for_fonts(o,this.json);var u=this;for(this.appPlayer=new XDAPP.Player;this.container.hasChildNodes();)this.container.removeChild(this.container.lastChild);!!document.documentMode?this.container.appendChild(this.appPlayer.dom):this.container.append(this.appPlayer.dom);var d=setInterval(function(){if(xtrad_fontCount[o]<=0){clearInterval(d),xtrad_o_traverse(o,u.json),u.appPlayer.load(u.json,o);var s=setInterval(function(){if(xtrad_Water<=0&&xtrad_CubeTexture[o]<=0){if(clearInterval(s),null!=u.orbit&&null!=u.orbit.orbit&&"true"===u.orbit.orbit){var t=0;null!=u.orbit.minPolarAngle&&0<u.orbit.minPolarAngle.length&&(t=u.orbit.minPolarAngle);var e=90;null!=u.orbit.maxPolarAngle&&0<u.orbit.maxPolarAngle.length&&(e=u.orbit.maxPolarAngle);var a=-1/0;null!=u.orbit.minAzimuthAngle&&0<u.orbit.minAzimuthAngle.length&&(a=u.orbit.minAzimuthAngle);var i=1/0;null!=u.orbit.maxAzimuthAngle&&0<u.orbit.maxAzimuthAngle.length&&(i=u.orbit.maxAzimuthAngle);var r=10;null!=u.orbit.minDistance&&0<u.orbit.minDistance.length&&(r=u.orbit.minDistance);var n=1e3;null!=u.orbit.maxDistance&&0<u.orbit.maxDistance.length&&(n=u.orbit.maxDistance),u.appPlayer.addOrbitControl(t,e,a,i,r,n)}return u.appPlayer.setSize(u.width,u.height),u.containerimage.style.display="none",u.container.style.display="block",void u.appPlayer.play(!1)}},500,u)}},500,u)}catch(t){alert(t)}},this.play=function(){this.appPlayer.play(!1)},this.setSize=function(t){this.width=t,this.height=t*(this.heightRatio/100),this.appPlayer.setSize(this.width,this.height)},this.stop=function(){this.appPlayer.stop(!1)},this.dispose=function(){null!=this.appPlayer&&this.appPlayer.dispose()}}},XTRADANIMATION||{});(XTRADANIMATION={Animation:function(t){this.editor=t,this.parserGrammar='animation\n = statements:statements { return statements; } \n\nstatements\n = (statement)+ \n\nstatement\n = durationstatement / loopstatement / looprepstatement / loopppstatement / startstatement / rotationstatement / positionstatement / scalestatement / opacitystatement / colorstatement / visiblestatement\ndurationstatement\n = DURATION _ equals _ time:number _ { return { s: "duration", time: time}; }\nloopstatement\n = LOOP _ equals _ b:("true" / "false" / "TRUE" / "FALSE")  _  { return { s: "loop", b: b}; }\nlooprepstatement\n = LOOPREPETITION _ equals _ rep:number _  { return { s: "looprep", rep: rep}; }\nloopppstatement\n = LOOPPINGPONG _ equals _ b:("true" / "false" / "TRUE" / "FALSE")  _  { return { s: "looppp", b: b}; }\nstartstatement\n = START _ TIME _ equals _ time:number _ { return { s: "start", time: time}; }\nrotationstatement\n = ROTATION _ a:args _ colon _ p:parameters _ { return { s: "rotation", a: a, p: p}; }\npositionstatement\n = POSITION _ a:args _ colon _ p:parameters _ { return { s: "position", a: a, p: p}; }\nscalestatement\n = SCALE _ a:args _ colon _ p:parameters _ { return { s: "scale", a: a, p: p}; }\nopacitystatement\n = OPACITY _ a:args _ colon _ o:number _ { return { s: "opacity", a: a, o: o}; }\ncolorstatement\n = COLOR _ a:args _ colon _ r:number _ g:number _ b:number _ { return { s: "color", a: a, r: r, g: g, b: b}; }\nvisiblestatement\n = VISIBLE _ a:args _ colon _ b:("true" / "false" / "TRUE" / "FALSE")  _  { return { s: "visible", a: a, b: b}; }\nargs\n = _ ( startop / timeop )\nstartop\n = START { return { s: "start", time: 0 }; }\ntimeop\n = TIME _ equals _ time:number { return { s: "time", time: time }; }\nparameters\n = w:( _ a:AXIS _ equals _ n:number _ )+ { return { type: "label", w: w }; } / x:number _ y:number _ z:number { return { type: "nolabel", x: x, y: y, z: z }; }\nAXIS\n = "x" / "y" / "z" / "X" / "Y" / "Z"\nTIME\n = "time" / "TIME"\nDURATION\n = "duration" / "DURATION"\nLOOP\n = "loop" / "LOOP"\nLOOPREPETITION\n = "looprepetitions" / "LOOPREPETITIONS"\nLOOPPINGPONG\n = "looppingpong" / "LOOPPINGPONG"\nSTART\n = "start" / "START"\nROTATION\n = "rotation" / "ROTATION" / "rot" / "ROT"\nPOSITION\n = "position" / "POSITION" / "pos" / "POS"\nSCALE\n = "scale" / "SCALE"\nOPACITY\n = "opacity" / "OPACITY"\nCOLOR\n = "color" / "COLOR" / "colour" / "COLOUR"\nVISIBLE\n = "visible" / "VISIIBLE"\nsimplestring\n = _ s:string _ { return { type: "string", param: s}; }\n _  = [ \\t\\n\\r]* \n\n// ----- 7. Strings -----\n\nstring "string"\n = quotation_mark chars:char* quotation_mark { return chars.join(""); }\nchar\n = unescaped\n / escape\n sequence:(\n  \'"\'\n  / "\\\\"  / "/"  / "b" { return "\\b"; }\n  / "f" { return "\\f"; }\n  / "n" { return "\\n"; }\n  / "r" { return "\\r"; }\n  / "t" { return "\\t"; }\n  / "u" digits:$(HEXDIG HEXDIG HEXDIG HEXDIG) {\n       return String.fromCharCode(parseInt(digits, 16));\n      }\n  )\n  { return sequence; }\n\nescape\n = "\\\\"\n\nquotation_mark\n = \'"\'\n\nunescaped\n  = [^\\0-\\x1F\\x22\\x5C]\nless_than\n = "<"\ngreater_than\n = ">"\nforward_slash\n = "/"\nequals\n = "="\nleft_square\n = "["\nright_square\n = "]"\ncolon\n = ":"\nnumber "number"\n = minus? int frac? exp? { return parseFloat(text()); }\ndecimal_point\n = "."\ndigit1_9\n = [1-9]\ne\n = [eE]\nexp\n = e (minus / plus)? DIGIT+\nfrac\n = decimal_point DIGIT+\nint\n = zero / (digit1_9 DIGIT*)\nminus\n = "-"\nplus\n = "+"\nzero\n = "0"\nDIGIT  = [0-9]\nHEXDIG = [0-9a-f]i\nhexcolor\n = "#" c:HEXDIG+ { return "#" + c.join(""); }'}}).Animation.prototype.parseAnimation=function(t,e){for(var a,i=10,r=0,n=!0,s=0,o=!1,h=[],c=[],l=[],u=[],d=[],p=[],g=0,b=0,m=0,f=0,y=0,k=0,T=0,E=0,R=0,v=(a=peg.generate(this.parserGrammar).parse(e)).length;R<v;R++){var x=a[R];switch(x.s){case"duration":i=x.time;break;case"loop":n="true"===x.b||"TRUE"===x.b;break;case"looprep":s=x.rep;break;case"looppp":o="true"===x.b||"TRUE"===x.b;break;case"start":r=x.time;break;case"rotation":var D=Dt(x.a),O=Ot(x.p),X={},w=t.rotation.x*(180/Math.PI),P=t.rotation.y*(180/Math.PI),j=t.rotation.z*(180/Math.PI);"start"===D.type?(X.time=D.time,X.x=-99999!==O.X?O.X+w:O.X,X.y=-99999!==O.Y?O.Y+P:O.Y,X.z=-99999!==O.Z?O.Z+j:O.Z,h.unshift(X),y=X.x,k=X.y,T=X.z,E=X.time):0<r?(X.time=E+r,X.x=y,X.y=k,X.z=T,h.push(X),y=-99999!==O.X?O.X+w:O.X,k=-99999!==O.Y?O.Y+P:O.Y,T=-99999!==O.Z?O.Z+j:O.Z,E=D.time):(X.time=D.time,X.x=-99999!==O.X?O.X+w:O.X,X.y=-99999!==O.Y?O.Y+P:O.Y,X.z=-99999!==O.Z?O.Z+j:O.Z,h.push(X));break;case"position":D=Dt(x.a);var C=Ot(x.p),M={};"start"===D.type?(M.time=D.time,M.x=-99999!==C.X?C.X+t.position.x:C.X,M.y=-99999!==C.Y?C.Y+t.position.y:C.Y,M.z=-99999!==C.Z?C.Z+t.position.z:C.Z,c.unshift(M),g=M.x,b=M.y,m=M.z,f=M.time):0<r?(M.time=f+r,M.x=g,M.y=b,M.z=m,c.push(M),g=-99999!==C.X?C.X+t.position.x:C.X,b=-99999!==C.Y?C.Y+t.position.y:C.Y,m=-99999!==C.Z?C.Z+t.position.z:C.Z,f=D.time):(M.time=D.time+r,M.x=-99999!==C.X?C.X+t.position.x:C.X,M.y=-99999!==C.Y?C.Y+t.position.y:C.Y,M.z=-99999!==C.Z?C.Z+t.position.z:C.Z,c.push(M));break;case"scale":D=Dt(x.a);var I=Ot(x.p),S={};S.time=D.time,S.x=-99999!==I.X?I.X+t.scale.x:I.X,S.y=-99999!==I.Y?I.Y+t.scale.y:I.Y,S.z=-99999!==I.Z?I.Z+t.scale.z:I.Z,"start"===D.type?l.unshift(S):l.push(S);break;case"opacity":D=Dt(x.a);var A={};A.time=D.time,A.opacity=x.o,"start"===D.type?u.unshift(A):u.push(A);break;case"color":D=Dt(x.a);var H={};H.time=D.time,H.r=x.r,H.g=x.g,H.b=x.b,"start"===D.type?d.unshift(H):d.push(H);break;case"visible":D=Dt(x.a);(ft={}).time=D.time,ft.visible=x.b,"start"===D.type?p.unshift(ft):p.push(ft)}}if(0<r){if(0<c.length)(M={}).time=f+r,M.x=g,M.y=b,M.z=m,c.push(M);if(0<h.length)(X={}).time=E+r,X.x=y,X.y=k,X.z=T,h.push(X)}var z={};z.loopState=n,z.loopRepetitions=s,z.loopPingPong=o,z.duration=i,z.startTime=r,z.groupName=t.name,z.positions=c,z.rotations=h,z.scale=l,z.color=d,z.opacity=u,z.visible=p;var _=1,V=(i=z.duration,xtrad_Viewer.scene.duration);if(-1!==i)_=V/i;var G=[];if(t.animations.loopState=z.loopState,t.animations.loopRepetitions=z.loopRepetitions,t.animations.loopPingPong=z.loopPingPong,0<z.positions.length){for(var W=0,B=0,N=0,L=[],F=[],Y=z.groupName+".position",U=0,Z=z.positions.length;U<Z;U++){C=z.positions[U];L.push(C.time*_),-99999!==C.x&&(W=C.x),-99999!==C.y&&(B=C.y),-99999!==C.z&&(N=C.z),F.push(W),F.push(B),F.push(N)}var q=new XDTHREE.VectorKeyframeTrack(Y,L,F,XDTHREE.InterpolateLinear);G.push(q)}if(0<z.rotations.length){for(var J=0,K=0,Q=0,$=[],tt=[],et=z.groupName+".quaternion",at=0,it=z.rotations.length;at<it;at++){O=z.rotations[at];$.push(O.time*_),-99999!==O.x&&(J=O.x),-99999!==O.y&&(K=O.y),-99999!==O.z&&(Q=O.z);var rt=new XDTHREE.Euler(J*Math.PI/180,K*Math.PI/180,Q*Math.PI/180,"XYZ"),nt=(new XDTHREE.Quaternion).setFromEuler(rt);tt.push(nt.x),tt.push(nt.y),tt.push(nt.z),tt.push(nt.w)}var st=new XDTHREE.QuaternionKeyframeTrack(et,$,tt,XDTHREE.InterpolateLinear);G.push(st)}if(0<z.scale.length){for(var ot=0,ht=0,ct=0,lt=[],ut=[],dt=z.groupName+".scale",pt=0,gt=z.scale.length;pt<gt;pt++){var bt=z.scale[pt];lt.push(bt.time*_),-99999!==bt.x&&(ot=bt.x),-99999!==bt.y&&(ht=bt.y),-99999!==bt.z&&(ct=bt.z),ut.push(ot),ut.push(ht),ut.push(ct)}var mt=new XDTHREE.VectorKeyframeTrack(dt,lt,ut,XDTHREE.InterpolateSmooth);G.push(mt)}if(0<z.visible.length){for(var ft=0,yt=[],kt=[],Tt=z.groupName+".visible",Et=0,Rt=z.visible.length;Et<Rt;Et++){var vt=z.visible[Et];yt.push(vt.time*_),kt.push(ft)}var xt=new XDTHREE.VectorKeyframeTrack(Tt,yt,kt,XDTHREE.InterpolateLinear);G.push(xt)}function Dt(t){var e=t[0];0===t[0].length&&(e=t[1]);var a={};return a.type=e.s,a.time=e.time,a}function Ot(t){var e=-99999,a=-99999,i=-99999;switch(t.type){case"label":for(var r=0,n=t.w.length;r<n;r++){var s,o,h=t.w[r][0];0===h.length&&(h=t.w[r][1]),s=h;var c=t.w[r][6];switch(Array.isArray(c)&&(c=t.w[r][5]),o=c,s){case"x":e=o;break;case"y":a=o;break;case"z":i=o}}break;case"nolabel":e=t.x,a=t.y,i=t.z}var l={};return l.X=e,l.Y=a,l.Z=i,l}t.animations.clip=new XDTHREE.AnimationClip("editclip",i,G,!0),null!=t.animations.action&&(!1===t.animations.loopState?t.animations.action.setLoop(XDTHREE.LoopOnce,0):!0===t.animations.loopState&&!1===this.loopPingPong?t.animations.action.setLoop(XDTHREE.LoopRepeat,0===t.animations.loopRepetitions?1e6:t.animations.loopRepetitions):!0===t.animations.loopState&&!0===t.animations.loopPingPong&&t.animations.action.setLoop(XDTHREE.LoopPingPong,0===t.animations.loopRepetitions?1e6:t.animations.loopRepetitions))},XTRADANIMATION.Animation.prototype.updateAnimations=function(t,e){var a=null==e.loopState||e.loopState,i=null!=e.loopRepetitions?e.loopRepetitions:0,r=null!=e.loopPingPong&&e.loopPingPong;if(null!=e.clip)var n=e.clip;else n=e;for(var s={},o=0;o<n.tracks.length;o++){var h=n.tracks[o].name,c=h.substring(h.lastIndexOf(".")+1),l=h.substring(0,h.lastIndexOf(".")),u=null,d=XDTHREE.InterpolateLinear;switch(c.toLowerCase()){case"position":case"scale":u=XDTHREE.VectorKeyframeTrack;break;case"quaternion":u=XDTHREE.QuaternionKeyframeTrack,d=XDTHREE.InterpolateLinear;break;case"opacity":u=XDTHREE.NumberKeyframeTrack;break;case"visible":u=XDTHREE.BooleanKeyframeTrack,d=XDTHREE.InterpolateDiscrete;break;case"color":u=XDTHREE.ColorKeyframeTrack;break;default:alert("Unknown interpolation type - "+c.toLowerCase())}var p=n.tracks[o].times;if(!Array.isArray(n.tracks[o].times))for(var g in p=[],n.tracks[o].times)p.push(n.tracks[o].times[g]);var b=n.tracks[o].values;if(!Array.isArray(n.tracks[o].values))for(var m in b=[],n.tracks[o].values)b.push(n.tracks[o].values[m]);var f=new u(h,p,b,d);f.times=Array.prototype.slice.call(f.times),f.values=Array.prototype.slice.call(f.values),null==s[l]&&(s[l]=[]),s[l].push(f)}for(key in s){var y=t.getObjectByName(key);null==y.animations&&(y.animations={}),y.animations.clip=new XDTHREE.AnimationClip(key,e.clip.duration,s[key]),y.animations.loopPingPong=r,y.animations.loopRepetitions=i,y.animations.loopState=a}},XTRADVIEWER.CharAnimation=function(t,e){this.userData=t,this.children=e,this.first=!0,this.startTime=0,this.pauseAtEndTime=null!=this.userData.fly.pauseAtEnd?this.userData.fly.pauseAtEnd:0,this.noChars=this.children.length,this.totalTime=this.userData.fly.startTime+this.userData.fly.inTime+this.userData.fly.stayTime+this.userData.fly.outTime+this.pauseAtEndTime,this.pauseAtEndTimeStart=this.userData.fly.startTime+this.userData.fly.inTime+this.userData.fly.stayTime+this.userData.fly.outTime,this.inInt=this.userData.fly.inTime/this.noChars,this.outInt=this.userData.fly.outTime/this.noChars,this.words=this.userData.fly.text.split(" "),this.inIntWords=this.userData.fly.inTime/this.words.length,this.outIntWords=this.userData.fly.outTime/this.words.length,this.startPositions=[],this.staticPositions=[];for(var a=0;a<this.noChars;a++){var i=new XDTHREE.Vector3(this.children[a].position.x,this.children[a].position.y,this.children[a].position.z);this.staticPositions.push(i)}switch(this.userData.fly.in){case"None":for(a=0;a<this.noChars;a++){var r=new XDTHREE.Vector3(this.children[a].position.x,this.children[a].position.y,this.children[a].position.z);this.startPositions.push(r)}break;case"Random":var n=Math.abs(this.userData.fly.startPosX),s=Math.abs(this.userData.fly.startPosY),o=Math.abs(this.userData.fly.startPosZ);switch(this.userData.fly.inType){case"SingleChar":for(a=0;a<this.noChars;a++){var h=Math.random()*n*2-n,c=Math.random()*s*2-s,l=Math.random()*o*2-o;r=new XDTHREE.Vector3(h,c,l);this.startPositions.push(r)}break;case"Word":var u=0;for(a=0;a<this.words.length;a++){(v=u+this.words[a].length+1)>this.noChars&&(v=this.noChars);for(var d=Math.random()*n*2-n,p=Math.random()*s*2-s,g=Math.random()*o*2-o,b=u;b<v;b++){r=new XDTHREE.Vector3(this.children[b].position.x+d,this.children[b].position.y+p,this.children[b].position.z+g);this.startPositions.push(r)}(u+=this.words[a].length+1)>=this.noChars&&(u=this.noChars-1)}break;case"All":var m=Math.random()*n*2-n,f=Math.random()*s*2-s,y=Math.random()*o*2-o;for(a=0;a<this.noChars;a++){r=new XDTHREE.Vector3(this.children[a].position.x+m,this.children[a].position.y+f,this.children[a].position.z+y);this.startPositions.push(r)}}break;case"Linear":case"NegativeToPositive":case"PositiveToNegative":for(a=0;a<this.noChars;a++){r=new XDTHREE.Vector3(this.children[a].position.x+this.userData.fly.startPosX,this.children[a].position.y+this.userData.fly.startPosY,this.children[a].position.z+this.userData.fly.startPosZ);this.startPositions.push(r)}}this.endPositions=[];var k=null!=this.userData.fly.endPosX?this.userData.fly.endPosX:-this.userData.fly.startPosX,T=null!=this.userData.fly.endPosY?this.userData.fly.endPosY:-this.userData.fly.startPosY,E=null!=this.userData.fly.endPosZ?this.userData.fly.endPosZ:-this.userData.fly.startPosZ;switch(this.userData.fly.out){case"None":for(a=0;a<this.noChars;a++){var R=new XDTHREE.Vector3(this.children[a].position.x,this.children[a].position.y,this.children[a].position.z);this.endPositions.push(R)}break;case"Random":n=Math.abs(this.userData.fly.endPosX),s=Math.abs(this.userData.fly.endPosY),o=Math.abs(this.userData.fly.endPosZ);switch(this.userData.fly.outType){case"SingleChar":if("Random"===this.userData.fly.in)for(a=0;a<this.noChars;a++){R=new XDTHREE.Vector3(this.startPositions[a].x,this.startPositions[a].y,this.startPositions[a].z);this.endPositions.push(R)}else for(a=0;a<this.noChars;a++){h=Math.random()*n*2-n,c=Math.random()*s*2-s,l=Math.random()*o*2-o,R=new XDTHREE.Vector3(h,c,l);this.endPositions.push(R)}break;case"Word":if("Random"===this.userData.fly.in&&0===this.userData.fly.endPosX&&0===this.userData.fly.endPosY&&0===this.userData.fly.endPosZ)for(a=0;a<this.noChars;a++){R=new XDTHREE.Vector3(this.startPositions[a].x,this.startPositions[a].y,this.startPositions[a].z);this.endPositions.push(R)}else for(u=0,a=0;a<this.words.length;a++){(v=u+this.words[a].length+1)>this.noChars&&(v=this.noChars);for(d=Math.random()*n*2-n,p=Math.random()*s*2-s,g=Math.random()*o*2-o,b=u;b<v;b++){r=new XDTHREE.Vector3(this.children[b].position.x+d,this.children[b].position.y+p,this.children[b].position.z+g);this.endPositions.push(r)}(u+=this.words[a].length+1)>=this.noChars&&(u=this.noChars-1)}break;case"All":for(m=Math.random()*n*2-n,f=Math.random()*s*2-s,y=Math.random()*o*2-o,a=0;a<this.noChars;a++){R=new XDTHREE.Vector3(this.children[a].position.x+m,this.children[a].position.y+f,this.children[a].position.z+y);this.startPositions.push(R)}}break;case"NegativeToPositive":case"PositiveToNegative":case"Linear":for(a=0;a<this.noChars;a++){R=new XDTHREE.Vector3(this.children[a].position.x+k,this.children[a].position.y+T,this.children[a].position.z+E);this.endPositions.push(R)}}switch(this.inTimes=[],this.outTimes=[],this.userData.fly.inType){case"SingleChar":for(a=0;a<this.noChars;a++){(x=[]).s=this.userData.fly.startTime+this.inInt*a,x.e=x.s+this.inInt,this.inTimes.push(x)}break;case"Word":for(u=0,a=0;a<this.words.length;a++){var v=u+this.words[a].length;for(b=u;b<v;b++){(x=[]).s=this.userData.fly.startTime+this.inIntWords*a,x.e=x.s+this.inIntWords,this.inTimes.push(x)}if((u+=this.words[a].length)>=this.userData.fly.text.length)u=this.userData.fly.text.length-1;else(x=[]).s=0,x.e=0,this.inTimes.push(x)}break;case"All":for(a=0;a<this.noChars;a++){var x;(x=[]).s=this.userData.fly.startTime,x.e=x.s+this.userData.fly.inTime,this.inTimes.push(x)}}switch(this.userData.fly.outType){case"SingleChar":for(a=0;a<this.noChars;a++){(D=[]).s=this.userData.fly.startTime+this.userData.fly.inTime+this.userData.fly.stayTime+this.outInt*a,D.e=D.s+this.outInt,this.outTimes.push(D)}break;case"Word":for(u=0,a=0;a<this.words.length;a++){for(v=u+this.words[a].length,b=u;b<v;b++){(D=[]).s=this.userData.fly.startTime+this.userData.fly.inTime+this.userData.fly.stayTime+this.outIntWords*a,D.e=D.s+this.outIntWords,this.outTimes.push(D)}if((u+=this.words[a].length)>=this.userData.fly.text.length)u=this.userData.fly.text.length-1;else(D=[]).s=0,D.e=0,this.outTimes.push(D)}break;case"All":for(a=0;a<this.noChars;a++){var D;(D=[]).s=this.userData.fly.startTime+this.userData.fly.inTime+this.userData.fly.stayTime,D.e=D.s+this.userData.fly.outTime,this.outTimes.push(D)}}},XTRADVIEWER.CharAnimation.prototype.updateCharacters=function(t,e){if(this.first){this.first=!1,this.startTime=t;for(var a=0;a<this.noChars;a++){(s=e[a]).position.x=this.startPositions[a].x,s.position.y=this.startPositions[a].y,s.position.z=this.startPositions[a].z}}for(var i=.001*(t-this.startTime),r=this.userData.fly.startTime+this.userData.fly.inTime+this.userData.fly.stayTime,n=(this.userData.fly.startTime,this.userData.fly.inTime,0);n<this.noChars;n++){var s=e[n];if(i>=this.outTimes[n].s&&i<this.outTimes[n].e){var o=i-this.outTimes[n].s,h=0;switch(this.userData.fly.outType){case"SingleChar":h=o/this.outInt;break;case"Word":h=o/this.outIntWords;break;case"All":h=o/this.userData.fly.outTime}var c=g(h,this.userData.fly.outEasing),l=(this.endPositions[n].x-this.staticPositions[n].x)*c,u=(this.endPositions[n].y-this.staticPositions[n].y)*c,d=(this.endPositions[n].z-this.staticPositions[n].z)*c;s.position.x=this.staticPositions[n].x+l,s.position.y=this.staticPositions[n].y+u,s.position.z=this.staticPositions[n].z+d}else if(i>=this.inTimes[n].e&&i<r)s.position.x=this.staticPositions[n].x,s.position.y=this.staticPositions[n].y,s.position.z=this.staticPositions[n].z;else if(i<this.inTimes[n].s)s.position.x=this.startPositions[n].x,s.position.y=this.startPositions[n].y,s.position.z=this.startPositions[n].z;else if(i>=this.outTimes[n].e)s.position.x=this.endPositions[n].x,s.position.y=this.endPositions[n].y,s.position.z=this.endPositions[n].z;else if(i>=this.inTimes[n].s&&i<this.inTimes[n].e){var p=i-this.inTimes[n].s;h=0;switch(this.userData.fly.inType){case"SingleChar":h=(this.inInt-p)/this.inInt;break;case"Word":h=(this.inIntWords-p)/this.inIntWords;break;case"All":h=(this.userData.fly.inTime-p)/this.userData.fly.inTime}c=g(h,this.userData.fly.inEasing),l=(this.staticPositions[n].x-this.startPositions[n].x)*c,u=(this.staticPositions[n].y-this.startPositions[n].y)*c,d=(this.staticPositions[n].z-this.startPositions[n].z)*c;s.position.x=this.staticPositions[n].x-l,s.position.y=this.staticPositions[n].y-u,s.position.z=this.staticPositions[n].z-d}}function g(t,e){switch(e){case"Linear":return t;case"InCubic":return b(t);case"OutCubic":return 1-b(1-t);case"InOutCubic":return(s=t)<.5?4*s*s*s:(s-1)*(2*s-2)*(2*s-2)+1;case"InQuad":return m(t);case"OutQuad":return 1-m(1-t);case"InOutQuad":return(n=t)<.5?2*n*n:(4-2*n)*n-1;case"InElastic":return(.04-.04/(r=t))*Math.sin(25*r)+1;case"OutElastic":return.04*(i=t)/--i*Math.sin(25*i);case"InOutElastic":return a=t,(a-=.5)<0?(.02+.01/a)*Math.sin(50*a):(.02-.01/a)*Math.sin(50*a)+1}var a,i,r,n,s}function b(t){return Math.pow(t,3)}function m(t){return t*t}i>this.totalTime&&(this.first=!0)},XTRADVIEWER.CharObjectCreate=function(){},XTRADVIEWER.CharObjectCreate.prototype.generateCharObject=function(t,e,a,i,r,n,s,o,h,c,l,u,d,p,g,b,m,f,y,k,T,E){var R=[];if("Shader"===u)R=p;else if("Reflection"===u)R=[new XDTHREE.MeshPhongMaterial({color:16777215,envMap:t.scene.background.backgroundObject,flatShading:!0}),new XDTHREE.MeshPhongMaterial({color:16777215,envMap:t.scene.background.backgroundObject})];else if("Refraction"===u){var v=new XDTHREE.MeshPhongMaterial({color:16777215,envMap:t.scene.background.backgroundObject,refractionRatio:.95,flatShading:!0});v.envMap.mapping=XDTHREE.CubeRefractionMapping;var x=new XDTHREE.MeshPhongMaterial({color:16777215,envMap:t.scene.background.backgroundObject,refractionRatio:.95});x.envMap.mapping=XDTHREE.CubeRefractionMapping,R=[v,x]}else if("Image"===u){var D=new XDTHREE.MeshBasicMaterial({map:g});R=[D,D]}else R=[new XDTHREE.MeshStandardMaterial({color:"Fixed"===u?d:randomColor(),opacity:b,transparent:b<1,metalness:m,roughness:f,flatShading:!0}),new XDTHREE.MeshStandardMaterial({color:"Fixed"===u?d:randomColor(),opacity:b,transparent:b<1,metalness:m,roughness:f,flatShading:!1})];var O=new XDTHREE.Object3D;O.name="XtraCharPivot";for(var X=0;X<r.length;X++){if("RandomPerChar"===u){var w=randomColor();R=[new XDTHREE.MeshStandardMaterial({color:w,opacity:b,transparent:b<1,metalness:m,roughness:f,flatShading:!0}),new XDTHREE.MeshStandardMaterial({color:w,opacity:b,transparent:b<1,metalness:m,roughness:f,flatShading:!1})]}var P=r.charAt(X),j={fontType:a,fontName:i,colourType:u,text:P,font:n,materials:R,positionx:"center",size:s,height:0===o?.03:o,bevelEnabled:0!==o&&h,bevelThickness:0===o?0:l,bevelSize:0===o?0:c,material:0,extrudeMaterial:0===o?0:1,animateObject:y,animateRotations:k},C=(new XTRADVIEWER.Text).createText(j).children[0];C.name=P,O.add(C)}for(var M=[],I=0,S=0;S<O.children.length;S++){var A=O.children[S],H=(new XDTHREE.Box3).setFromObject(A),z=1;H.min.x<1e7&&(z=H.max.x-H.min.x),M.push(z),I+=z}var _=-I/2;for(S=0;S<O.children.length;S++){(A=O.children[S]).position.x=_,_+=M[S]}if("Rotation"===y||"RotationChar"===y||"Shader"===u&&"Fly"!==y){var V="function update( event ) {\nvar time = event.time * 0.001;\nvar delta = event.delta * 0.001;\n",G={objectRotations:{},groupRotations:{}};"Rotation"===y?(V+="this.rotation.x = time * this.userData.objectRotations.x;\nthis.rotation.y = time * this.userData.objectRotations.y;\nthis.rotation.z = time * this.userData.objectRotations.z;\n",G.objectRotations={x:k.x,y:k.y,z:k.z}):"RotationChar"===y&&(V+="for(var i = 0; i < this.children.length; i++){\n",V+="this.children[i].rotation.x = time * this.userData.objectRotations.x;\nthis.children[i].rotation.y = time * this.userData.objectRotations.y;\nthis.children[i].rotation.z = time * this.userData.objectRotations.z;\n",V+="}\n",G.objectRotations={x:k.x,y:k.y,z:k.z}),"Shader"===u&&(V+=E),V+="}"}else if("Fly"===y){(G={fly:{}}).fly=T,V=function(t,e,a){var i="";i+="var charUpdate = new XTRADVIEWER.CharAnimation(this.userData, this.children);\n",i+="function update( event ) {\nvar time = event.time * 0.001;\nvar delta = event.delta * 0.001;\n",i+="\tcharUpdate.updateCharacters(event.time, this.children);\n","Shader"===e&&(i+=a);return i+="}\n"}(0,u,E)}O.userData=G,t.execute(new AddObjectCommand(O));var W={name:"group"+type,source:V};t.execute(new AddScriptCommand(O,W))};