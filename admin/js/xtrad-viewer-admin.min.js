/*! xtrad-viewer 06-12-2019 */

var xtrad_Viewer=null,xtrad_homeUrl="",xtrad_pluginUrl="",xtrad_uploadUrl="",updateFcts=[];jQuery(document).ready(function(c){var e=c(".xtrad_viewer"),o=document.getElementById("xtrad_viewer"),l="";if(null!=e&&0!=e.length){xtrad_pluginUrl=xtradViewerData.pluginurl,xtrad_uploadUrl=xtradViewerData.uploadurl,c("#uploadingView").modal("hide"),xtrad_Viewer=new Editor(o,xtradViewerData.author),o.style.display="none",c(".edit-view").click(function(e){o.style.display="block";var a=c(this).attr("name"),t=a.lastIndexOf("-")+1;l=a.substring(t);var r=c("#edit-scene-id-"+l);r.val();var n={action:"get_scene",id:l},d=window.location.href,i=d.indexOf("/wp-admin"),s=d.substring(0,i)+"/wp-admin/admin-ajax.php";jQuery.post(s,n,function(e){var a=JSON.parse(e).scene[0],t=(a.image,a.heightratio);xtrad_Viewer.heightRatio=t;var r=a.type,n=a.name,d=a.id,i=a.scenedata;"compressed"===r&&(i=(new Huffman).decompress(i));var s=JSON.parse(i);xtrad_fontCount=[],xtrad_CubeTexture=[],xtrad_Water=0,xtrad_texg={},xtrad_fonts={},xtrad_fontCount.editor=0,xtrad_CubeTexture.editor=0,xtrad_o_traverse_for_fonts("editor",s);var o=setInterval(function(){if(xtrad_fontCount.editor<=0){clearInterval(o),xtrad_o_traverse("editor",s),c("#scene-name").val(n),c("#scene-id").val(d),c("#views-grid").css("display","none"),c("#single-view").css("display","block"),c("#editor").css("display","block"),xtrad_Viewer.clear();var e=50;null!=xtrad_Viewer.heightRatio&&(e=xtrad_Viewer.heightRatio);var a=0===xtrad_Viewer.container.clientWidth?xtrad_Viewer.container.parentNode.clientWidth:xtrad_Viewer.container.clientWidth,t=0<a?e/100*(a-300)+64:0;xtrad_Viewer.container.style.height=Math.round(t)+"px",xtrad_Viewer.signals.windowResize.dispatch(),xtrad_Viewer.fromJSON(s),xtrad_Viewer.config.setKey("project/title",n),xtrad_Viewer.scene.name=n,setTimeout(function(){xtrad_Viewer.signals.sceneGraphChanged.dispatch()},1e3)}},500)})}),c("#new-scene").click(function(e){c(this);c("#scene-name").val(""),c("#scene-id").val(0),c("#views-grid").css("display","none"),c("#single-view").css("display","block"),c("#editor").css("display","block"),xtrad_Viewer.clear();var a=0===xtrad_Viewer.container.clientWidth?xtrad_Viewer.container.parentNode.clientWidth:xtrad_Viewer.container.clientWidth,t=0<a?.5*(a-300)+64:0;xtrad_Viewer.container.style.height=Math.round(t)+"px",o.style.display="block",xtrad_Viewer.signals.windowResize.dispatch()}),c("#cancel-button").click(function(e){c(this);c("#scene-name").val(""),c("#scene-id").val(0),c("#views-grid").css("display","block"),c("#single-view").css("display","none"),c("#editor").css("display","block"),xtrad_Viewer.clear(),o.style.display="none"}),c("a.delete").click(function(e){e.preventDefault();var a=c("#deleteView");a.find("input[name=scene-id]").val(this.dataset.id),a.modal()});var a=new Viewport(xtrad_Viewer);e.append(a.dom);var t=new Player(xtrad_Viewer);e.append(t.dom);var r=new Toolbar(xtrad_Viewer);e.append(r.dom),r.dom.style.zIndex="999";var n=new Menubar(xtrad_Viewer);e.append(n.dom);var d=new Sidebar(xtrad_Viewer);e.append(d.dom);var i=new UI.Modal;e.append(i.dom),xtrad_Viewer.storage.init(function(){var a;function e(e){!1!==xtrad_Viewer.config.getKey("autosave")&&(clearTimeout(a),a=setTimeout(function(){xtrad_Viewer.signals.savingStarted.dispatch(),a=setTimeout(function(){xtrad_Viewer.storage.set(xtrad_Viewer.toJSON()),xtrad_Viewer.signals.savingFinished.dispatch()},100)},1e3))}var t=xtrad_Viewer.signals;t.geometryChanged.add(e),t.objectAdded.add(e),t.objectChanged.add(e),t.objectRemoved.add(e),t.materialChanged.add(e),t.sceneBackgroundChanged.add(e),t.sceneFogChanged.add(e),t.sceneGraphChanged.add(e),t.scriptChanged.add(e),t.historyChanged.add(e),t.showModal.add(function(e){i.show(e)})}),document.addEventListener("keydown",function(e){switch(e.keyCode){case 8:"scene-name"!==e.target.id&&e.preventDefault();break;case 46:if("scene-name"!==e.target.id){var a=xtrad_Viewer.selected;if(null!=a){var t=null!=a.name?a.name:"";if(!1===confirm("Delete "+t+"?"))return;if(void 0===a.parent)return;editor.execute(new RemoveObjectCommand(a))}else alert("You need to select an object first!")}break;case 90:(IS_MAC?e.metaKey:e.ctrlKey)&&(e.preventDefault(),e.shiftKey?xtrad_Viewer.redo():xtrad_Viewer.undo());break;case 87:"scene-name"!==e.target.id&&xtrad_Viewer.signals.transformModeChanged.dispatch("translate");break;case 69:"scene-name"!==e.target.id&&xtrad_Viewer.signals.transformModeChanged.dispatch("rotate");break;case 82:"scene-name"!==e.target.id&&xtrad_Viewer.signals.transformModeChanged.dispatch("scale")}}),document.addEventListener("dragover",function(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),document.addEventListener("drop",function(e){e.preventDefault(),0<e.dataTransfer.files.length&&xtrad_editor.loader.loadFile(e.dataTransfer.files[0])},!1),window.addEventListener("resize",s,!1),xtrad_Viewer.clear(),s(),c("#submit-button").click(function(e){return u()}),c("#submit-template-button").click(function(e){return u()})}function s(e){xtrad_Viewer.signals.windowResize.dispatch()}function u(){var e=document.getElementById("scene-name");if(0<e.value.length){var a=xtrad_Viewer.config.getKey("project/imagetype");null!=a&&"Manual"===a||xtrad_Viewer.signals.sceneCapture.dispatch(),c("#uploadingView").modal("show"),xtrad_Viewer.scene.name=e.value;var t=xtrad_Viewer.toJSON();xtrad_js_traverse(t,!1);var r=JSON.stringify(t);return r=r.replace(/(\.\d{3})(\d+)/g,"$1"),document.getElementById("viewer-json").value=r,document.getElementById("scene-image").value=t.project.image,document.getElementById("scene-hr").value=t.project.heightRatio,document.getElementById("viewer-mode").value="update",!0}return alert("You must supply a Scene Name"),!1}});